name: Orchestrator CI (manifests validation)

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up tools (kustomize)
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.4.3"

      - name: YAML lint (light)
        run: |
          python - <<'PY'
          import sys, pathlib
          import yaml
          bad = []
          for p in pathlib.Path(".").rglob("*.yaml"):
            # игнорим things like vendored / charts if появятся позже
            try:
              with p.open("r", encoding="utf-8") as f:
                list(yaml.safe_load_all(f))
            except Exception as e:
              bad.append((str(p), str(e)))
          if bad:
            print("YAML parse errors:")
            for f,e in bad:
              print(f"- {f}: {e}")
            sys.exit(1)
          print("YAML OK")
          PY

      - name: Kustomize build (base)
        run: |
          kustomize build k8s/base >/tmp/rendered.yaml
          echo "Rendered manifest size:"
          wc -l /tmp/rendered.yaml

      - name: Install kubeconform
        run: |
          set -euo pipefail
          VERSION="0.6.7"
          curl -sSL -o /tmp/kubeconform.tar.gz \
            "https://github.com/yannh/kubeconform/releases/download/v${VERSION}/kubeconform-linux-amd64.tar.gz"
          tar -xzf /tmp/kubeconform.tar.gz -C /tmp
          sudo mv /tmp/kubeconform /usr/local/bin/kubeconform
          sudo chmod +x /usr/local/bin/kubeconform
          kubeconform -v

      - name: kubeconform (schema validation)
        run: |
          kubeconform -strict -ignore-missing-schemas -summary /tmp/rendered.yaml